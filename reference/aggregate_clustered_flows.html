<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Aggregate clustered OD flows into representative lines — aggregate_clustered_flows • flowcluster</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Aggregate clustered OD flows into representative lines — aggregate_clustered_flows"><meta name="description" content="This function aggregates flows within clusters and creates a single
representative line for each cluster. The start and end coordinates are
computed as weighted averages (weighted by flow counts or another variable),
or simple means if no weights are provided. Each cluster is represented
by one LINESTRING."><meta property="og:description" content="This function aggregates flows within clusters and creates a single
representative line for each cluster. The start and end coordinates are
computed as weighted averages (weighted by flow counts or another variable),
or simple means if no weights are provided. Each cluster is represented
by one LINESTRING."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">flowcluster</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/hussein-mahfouz/flowcluster/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Aggregate clustered OD flows into representative lines</h1>
      <small class="dont-index">Source: <a href="https://github.com/hussein-mahfouz/flowcluster/blob/v0.2.1/R/linestring_aggregation.R" class="external-link"><code>R/linestring_aggregation.R</code></a></small>
      <div class="d-none name"><code>aggregate_clustered_flows.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function aggregates flows within clusters and creates a single
representative line for each cluster. The start and end coordinates are
computed as weighted averages (weighted by flow counts or another variable),
or simple means if no weights are provided. Each cluster is represented
by one <code>LINESTRING</code>.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">aggregate_clustered_flows</span><span class="op">(</span><span class="va">flows</span>, weight <span class="op">=</span> <span class="cn">NULL</span>, crs <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">flows</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-flows">flows<a class="anchor" aria-label="anchor" href="#arg-flows"></a></dt>
<dd><p>An <code>sf</code> object containing OD flows with coordinates for origins
(<code>x</code>, <code>y</code>) and destinations (<code>u</code>, <code>v</code>), a <code>cluster</code> column, and optionally
a <code>count</code> or other weighting variable.</p></dd>


<dt id="arg-weight">weight<a class="anchor" aria-label="anchor" href="#arg-weight"></a></dt>
<dd><p>(optional) Name of a column in <code>flows</code> to use for weighting.
If <code>NULL</code> (default), unweighted means are used.</p></dd>


<dt id="arg-crs">crs<a class="anchor" aria-label="anchor" href="#arg-crs"></a></dt>
<dd><p>Coordinate reference system for the output (default: taken from
<code>flows</code>).</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>An <code>sf</code> object with one line per cluster, containing:</p><ul><li><p><code>count_total</code>: total weight (if provided), otherwise number of flows</p></li>
<li><p><code>size</code>: the cluster size (from the input, not recomputed)</p></li>
<li><p><code>geometry</code>: a <code>LINESTRING</code> representing the aggregated OD flow</p></li>
</ul></div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># ----- 1. Basic Usage: A quick, runnable example ---</span></span></span>
<span class="r-in"><span><span class="co"># This demonstrates the function with minimal, fast data preparation.</span></span></span>
<span class="r-in"><span><span class="va">flows</span> <span class="op">&lt;-</span> <span class="fu">flowcluster</span><span class="fu">::</span><span class="va"><a href="flows_leeds.html">flows_leeds</a></span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Create the required input columns in a single, fast pipeline</span></span></span>
<span class="r-in"><span><span class="va">flows_clustered</span> <span class="op">&lt;-</span> <span class="va">flows</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="add_xyuv.html">add_xyuv</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="co"># Manually create 3 dummy clusters for demonstration</span></span></span>
<span class="r-in"><span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">flows</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="co"># The function requires a 'size' column, so we add it</span></span></span>
<span class="r-in"><span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">add_tally</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"size"</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Extracting start and end coordinates from flow geometries...</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Adding x, y, u, v columns to flow data...</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Assigning unique flow IDs...</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Demonstrate the function</span></span></span>
<span class="r-in"><span><span class="va">flows_agg_w</span> <span class="op">&lt;-</span> <span class="fu">aggregate_clustered_flows</span><span class="op">(</span><span class="va">flows_clustered</span>, weight <span class="op">=</span> <span class="st">"count"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">flows_agg_w</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Simple feature collection with 3 features and 7 fields</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Geometry type: LINESTRING</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Dimension:     XY</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Bounding box:  xmin: -1.554577 ymin: 53.80406 xmax: -1.547084 ymax: 53.80727</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Geodetic CRS:  WGS 84</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;"># A tibble: 3 × 8</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   cluster count_total  size     x     y     u     v                     geometry</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;LINESTRING [°]&gt;</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">1</span>       1       <span style="text-decoration: underline;">52</span>412  <span style="text-decoration: underline;">3</span>480 -<span style="color: #BB0000;">1.55</span>  53.8 -<span style="color: #BB0000;">1.55</span>  53.8 (-1.550539 53.80567, -1.549…</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">2</span>       2       <span style="text-decoration: underline;">52</span>227  <span style="text-decoration: underline;">3</span>411 -<span style="color: #BB0000;">1.55</span>  53.8 -<span style="color: #BB0000;">1.55</span>  53.8 (-1.554577 53.80727, -1.551…</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">3</span>       3       <span style="text-decoration: underline;">49</span>308  <span style="text-decoration: underline;">3</span>405 -<span style="color: #BB0000;">1.55</span>  53.8 -<span style="color: #BB0000;">1.55</span>  53.8 (-1.549737 53.80646, -1.547…</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># ----- 2. Detailed Workflow (not run by default) ---</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span>  <span class="co"># This example shows the ideal end-to-end workflow, from raw data</span></span></span>
<span class="r-in"><span>  <span class="co"># to clustering and finally aggregation. It is not run during checks</span></span></span>
<span class="r-in"><span>  <span class="co"># because the clustering steps are too slow.</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># a) Prepare the data by filtering and adding coordinates</span></span></span>
<span class="r-in"><span>  <span class="va">flows_prep</span> <span class="op">&lt;-</span> <span class="fu">flowcluster</span><span class="fu">::</span><span class="va"><a href="flows_leeds.html">flows_leeds</a></span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>    <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fl">3857</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="add_flow_length.html">add_flow_length</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="filter_by_length.html">filter_by_length</a></span><span class="op">(</span>length_min <span class="op">=</span> <span class="fl">5000</span>, length_max <span class="op">=</span> <span class="fl">12000</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="add_xyuv.html">add_xyuv</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># b) Calculate distances and cluster the flows</span></span></span>
<span class="r-in"><span>  <span class="va">distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="flow_distance.html">flow_distance</a></span><span class="op">(</span><span class="va">flows_prep</span>, alpha <span class="op">=</span> <span class="fl">1.5</span>, beta <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">dmat</span> <span class="op">&lt;-</span> <span class="fu"><a href="distance_matrix.html">distance_matrix</a></span><span class="op">(</span><span class="va">distances</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">wvec</span> <span class="op">&lt;-</span> <span class="fu"><a href="weight_vector.html">weight_vector</a></span><span class="op">(</span><span class="va">dmat</span>, <span class="va">flows_prep</span>, weight_col <span class="op">=</span> <span class="st">"count"</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">flows_clustered_real</span> <span class="op">&lt;-</span> <span class="fu"><a href="cluster_flows_dbscan.html">cluster_flows_dbscan</a></span><span class="op">(</span><span class="va">dmat</span>, <span class="va">wvec</span>, <span class="va">flows_prep</span>, eps <span class="op">=</span> <span class="fl">8</span>, minPts <span class="op">=</span> <span class="fl">70</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># c) Filter clusters and add a 'size' column</span></span></span>
<span class="r-in"><span>  <span class="va">flows_clustered_real</span> <span class="op">&lt;-</span> <span class="va">flows_clustered_real</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cluster</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># Filter out noise points</span></span></span>
<span class="r-in"><span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># d) Now, use the function on the clustered data</span></span></span>
<span class="r-in"><span>  <span class="va">flows_agg_real</span> <span class="op">&lt;-</span> <span class="fu">aggregate_clustered_flows</span><span class="op">(</span><span class="va">flows_clustered_real</span>, weight <span class="op">=</span> <span class="st">"count"</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">flows_agg_real</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span>  <span class="co"># e) Visualize the results</span></span></span>
<span class="r-in"><span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"tmap"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-tmap/tmap" class="external-link">tmap</a></span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="co"># This plot uses modern tmap v4 syntax.</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">flows_clustered_real</span>, facet <span class="op">=</span> <span class="st">"cluster"</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>      <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_lines.html" class="external-link">tm_lines</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"grey50"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_shape.html" class="external-link">tm_shape</a></span><span class="op">(</span><span class="va">flows_agg_real</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>      <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_lines.html" class="external-link">tm_lines</a></span><span class="op">(</span>col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>    <span class="fu"><a href="https://r-tmap.github.io/tmap/reference/tm_layout.html" class="external-link">tm_layout</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Original Flows (Grey) and Aggregated Flows (Red)"</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Hussein Mahfouz, Robin Lovelace.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

